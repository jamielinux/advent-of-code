- name: 'set_fact: input'
  ansible.builtin.set_fact:
    input: >-
      {{
        (
          lookup('ansible.builtin.file', 'input.txt')
        ).splitlines()
      }}

- name: 'set_fact: total_columns'
  ansible.builtin.set_fact:
    total_columns: '{{ input[0] | length }}'

- name: 'set_fact: input_trimmed'
  ansible.builtin.set_fact:
    input_trimmed: "{{ input | reject('eq', '.' * total_columns) }}"

- name: 'set_fact: rows'
  ansible.builtin.set_fact:
    rows: "{{ input_trimmed | map('list') }}"

- name: 'set_fact: start_column'
  ansible.builtin.set_fact:
    start_column: "{{ input_trimmed[0].index('S') }}"

- name: 'set_fact: beam_columns'
  ansible.builtin.set_fact:
    beam_columns: '{{ [start_column] }}'

- name: 'set_fact: solution'
  ansible.builtin.set_fact:
    solution: 0

# For each row:
#   1. Find splitters ('^') within the beam spread range.
#   2. Count hits where beams intersect splitters.
#   3. Update beam_columns (remove hit beams, add new split beams).
- name: 'process all rows'
  ansible.builtin.set_fact:
    # --- EXAMPLE ---
    # beam_columns (before)  =>  [3, 5]
    # splitter_columns       =>  [1, 3, 7]
    # new_beam_columns       =>  [2, 4]
    # difference(...)        =>  [5]
    # new + difference       =>  [2, 4, 5]
    # beam_columns (after)   =>  [2, 4, 5]
    beam_columns: >-
      {{
        (
          new_beam_columns
          + (beam_columns | difference(splitter_columns))
        )
        | sort
        | unique
      }}
    solution: '{{ solution + hits }}'
  vars:

    # Find all '^' cells in this row.
    #
    # --- EXAMPLE ---
    # row                  =>  ['.', '^', '.', '^', '.']
    # zip(range(5))        =>  [('.', 0), ('^', 1), ('.', 2), ('^', 3), ('.', 4)]
    # selectattr(.., '^')  =>  [('^', 1), ('^', 3)]
    # map(attribute='1')   =>  [1, 3]
    splitter_columns: >-
      {{
        row
        | zip(range(row | length))
        | selectattr('0', 'eq', '^')
        | map(attribute='1')
        | list
      }}

    # Count how many beams hit splitters.
    hits: '{{ beam_columns | intersect(splitter_columns) | length }}'
    # For each hit, the beam splits into two beams at col-1 and col+1.
    #
    # --- EXAMPLE ---
    # beam_columns      =>  [3, 5]
    # splitter_columns  =>  [1, 3, 7]
    # intersect(...)    =>  [3]
    # product([-1, 1])  =>  [(3, -1), (3, 1)]
    # map('sum')        =>  [2, 4]
    new_beam_columns: >-
      {{
        (beam_columns | intersect(splitter_columns))
        | product([-1, 1])
        | map('sum')
        | list
      }}

  loop: '{{ rows[1:] }}'
  loop_control:
    label: '{{ row_idx }}'
    loop_var: row
    index_var: row_idx

- name: 'print solution'
  tags: [print_action]
  ansible.builtin.debug:
    msg: 'ðŸŽ„ SOLUTION ðŸŽ„: {{ solution }}'
